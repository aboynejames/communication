<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src&#x2F;pouchdb.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/llLogic.html">llLogic</a></li>
            
                <li><a href="..&#x2F;classes/makeProgramme.html">makeProgramme</a></li>
            
                <li><a href="..&#x2F;classes/MasterWatch.html">MasterWatch</a></li>
            
                <li><a href="..&#x2F;classes/PerSwimmer.html">PerSwimmer</a></li>
            
                <li><a href="..&#x2F;classes/pouchdbSettings.html">pouchdbSettings</a></li>
            
                <li><a href="..&#x2F;classes/recordQS.html">recordQS</a></li>
            
                <li><a href="..&#x2F;classes/SwimtimeController.html">SwimtimeController</a></li>
            
                <li><a href="..&#x2F;classes/ttHTML.html">ttHTML</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src&#x2F;pouchdb.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
* Train TImer
*
* Train Timer settings, pouchDB
* @class pouchdbSettings
*
* @package    Train Timer part of open sport project
* @copyright  Copyright (c) 2012 James Littlejohn
* @license    http:&#x2F;&#x2F;www.gnu.org&#x2F;licenses&#x2F;old-licenses&#x2F;gpl-2.0.html
* @version    $Id$
*&#x2F;
var pouchdbSettings = function() {
  this.account = {};
	this.account[&#x27;pouchdbname&#x27;] = &#x27;idb:&#x2F;&#x2F;traintimer&#x27;;
	this.account[&#x27;pouch&#x27;] = &#x27;traintimer&#x27;;
	this.lanein = &#x27;&#x27;;

};

&#x2F;**
* save more than one document
* @method builkSave
*&#x2F;
pouchdbSettings.prototype.bulkSave = function(datain) {
	
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
			&#x2F;&#x2F; Opened a new database
			db.bulkDocs({docs: datain}, function(err, results) {
				&#x2F;&#x2F; Saved the documents into the database

			});
		});

};

&#x2F;**
* save one document
* @method singleSave
*&#x2F;
pouchdbSettings.prototype.singleSave = function(datain) {
		
	Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
		
		db.post(datain, function(err, response) {
		
		});
	});
};

&#x2F;**
* update one document
* @method updateSingle
*&#x2F;
pouchdbSettings.prototype.updateSingle = function(datain) {
		
	Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
		
		db.post(datain, function(err, response) {
		
		});
	});
};


&#x2F;**
* get list of all doc ids
* @method allDocs
*&#x2F;
pouchdbSettings.prototype.allDocs = function() {
	
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
			
					db.allDocs(function(err, response) {
&#x2F;&#x2F;console.log(response);	
						
					});
		});

};

&#x2F;**
* get data for speicific document ID
* @method getDoc
*&#x2F;
pouchdbSettings.prototype.getDoc = function(docid) {
	
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
			
			db.get(docid, function(err, doc) {

&#x2F;&#x2F;console.log(doc);	
				syncdataforsave =  JSON.stringify(doc);
				$.post(&quot;&#x2F;sync&#x2F;&quot;, syncdataforsave ,function(result){
					&#x2F;&#x2F; put a message back to UI to tell of a successful sync
&#x2F;&#x2F;console.log(&#x27;callback from sync to couchdb via node is complete&#x27;);	
			
				});
			});
		});

};

&#x2F;**
* update a document
* @method putDoc
*&#x2F;
pouchdbSettings.prototype.putDoc = function(designdoc) {
	
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
			
			db.put( designdoc ,  function(err, doc) {

&#x2F;&#x2F;console.log(doc);	
				
			});
		});

};

&#x2F;**
*  query all swimmer data in pouch
* @method mapQueryswimmers
*&#x2F;
pouchdbSettings.prototype.mapQueryswimmers = function(callbackin) {
&#x2F;&#x2F;console.log(&#x27;lane number in&#x27; + lanein);		
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
&#x2F;&#x2F;console.log(&#x27;lane number in pouch&#x27; + lanein);				
				function map(swimquery) {
					if(swimquery.name) {
						emit(swimquery.lanetrain, [swimquery.swimmerid, swimquery.name]);
					}
				}

				db.query({map: map}, {reduce: false}, function(err, response) {
&#x2F;&#x2F;console.log(response);		
				callbackin(response);
			});
		});

};


&#x2F;**
* list of all swimmers by name
* @method mapQueryname
*&#x2F;
pouchdbSettings.prototype.mapQueryname = function(lanein, callbackin) {
&#x2F;&#x2F;console.log(&#x27;lane number in&#x27; + lanein);		
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
&#x2F;&#x2F;console.log(&#x27;lane number in pouch&#x27; + lanein);				
				function map(lanequery) {
&#x2F;&#x2F;console.log(&#x27;lane number in map&#x27; + lanequery[&#x27;lanein&#x27;]);			
					if(lanequery.lanetrain) {
					emit(lanequery.lanetrain, [lanequery.swimmerid, lanequery.name]);
					}
				}

				db.query({map: map}, {reduce: false}, function(err, response) {
&#x2F;&#x2F;console.log(response);		
				callbackin(response);
			});
		});

};

&#x2F;**
* communication programme by date
* @method mapQueryCommdate
*&#x2F;
pouchdbSettings.prototype.mapQueryCommdate = function(commdatein, callbackin) {
&#x2F;&#x2F;console.log(&#x27;lane number in&#x27; + lanein);		
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
&#x2F;&#x2F;console.log(&#x27;lane number in pouch&#x27; + lanein);				
				function map(commquery) {
		
					if(commquery.commdate) {
					emit(commquery.commdate, [commquery.swimmerid, commquery.communication, commquery.commid]);
					}
				}

				db.query({map: map}, {reduce: false}, function(err, response) {
&#x2F;&#x2F;console.log(response);		
				callbackin(response);
			});
		});

};


&#x2F;**
* get splits data
* @method mapQuerySplits
*&#x2F;
pouchdbSettings.prototype.mapQuerySplits = function(lanein, callbackin) {
&#x2F;&#x2F;console.log(&#x27;lane number in&#x27; + lanein);		
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
&#x2F;&#x2F;console.log(&#x27;lane number in pouch&#x27; + lanein);				
				function map(splitsquery) {
&#x2F;&#x2F;console.log(&#x27;lane number in map&#x27; + lanequery[&#x27;lanein&#x27;]);			
					if(splitsquery.session) {
					emit(splitsquery.swimmerid, splitsquery.session);
					}
				}

				db.query({map: map}, {reduce: false}, function(err, response) {
&#x2F;&#x2F;console.log(response);		
				callbackin(response);
			});
		});

};

&#x2F;**
* delete a document
* @method deleteDoc
*&#x2F;
pouchdbSettings.prototype.deleteDoc = function(docid) {
	
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
&#x2F;&#x2F;console.log(docid);		
		db.get(docid, function(err, docout) {
&#x2F;&#x2F;console.log(&#x27;docid returned&#x27;);
&#x2F;&#x2F;console.log(docout);			
			db.remove(docout, function(err, response) {
&#x2F;&#x2F;console.log(&#x27;remove response&#x27;);
&#x2F;&#x2F;console.log(response);				
				
			});
		});
	});

};

&#x2F;**
* view change log
* @method changeLog
*&#x2F;
pouchdbSettings.prototype.changeLog = function(synccallback) {
	
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
			
		db.changes(function(err, response) {
&#x2F;&#x2F;console.log(response);
				synccallback(response);
			});

		});

};

&#x2F;**
* changelog by name
* @method filterchangeLog
*&#x2F;
pouchdbSettings.prototype.filterchangeLog = function(callbackin) {
	
		Pouch(this.account[&#x27;pouchdbname&#x27;], function(err, db) {
			
		db.changes( {filter : &#x27;swimmers&#x2F;justname&#x27;}, function(err, response) {
&#x2F;&#x2F;console.log(response);
			callbackin(response);
			
			
			});

		});

};

&#x2F;**
* internal pouchDB replication function (not working)
* @method replicate
*&#x2F;
pouchdbSettings.prototype.replicate = function() {
&#x2F;&#x2F;console.log(&#x27;replication started ouside&#x27;);	
			Pouch.replicate(this.account[&#x27;pouchdbname&#x27;], &#x27;http:&#x2F;&#x2F;localhost:5984&#x2F;traintimer&#x2F;&#x27;, function(err, changes) {
  &#x2F;&#x2F;
&#x2F;&#x2F;console.log(&#x27;replication started&#x27;);				
			});			

};

&#x2F;**
* Delete the pouchDB database
* @method deletePouch
*&#x2F;
pouchdbSettings.prototype.deletePouch = function() {

		Pouch.destroy(this.account[&#x27;pouchdbname&#x27;], function(err, info) {
			&#x2F;&#x2F; database deleted
		});

};

&#x2F;**
* query pouch for data on  a per swimmer basis
* @method returndatacallback
*&#x2F;
pouchdbSettings.prototype.returndatacallback = function(swimidin, datatypein) {
&#x2F;&#x2F;console.log(datatypein + &#x27;what id going to pouchclass&#x27;);
historicalswimdata = {};
	&#x2F;&#x2F; need to query pouch for the data
	&#x2F;&#x2F; test splits data recall						
	function localDataSPcall(swimidin, callback) {  
						livepouch.mapQuerySplits(swimidin, callback);

					}  
      
					swimprepared = localDataSPcall(swimidin, function(spmap) {

						historicalswimdata = {};	
							
						&#x2F;&#x2F; the current swim settings
						swimsetlive = {};
						&#x2F;&#x2F;swimsetlive[&quot;swimdate&quot;] = $(&quot;#swimdate&quot;).text();
						swimsetlive[&quot;swimstyle&quot;] = $(&quot;#swimstyle&quot;).val();
						swimsetlive[&quot;swimstroke&quot;] = $(&quot;#swimstroke&quot;).val();
						swimsetlive[&quot;swimtechnique&quot;] = $(&quot;#swimtechnique&quot;).val();
						swimsetlive[&quot;swimdistance&quot;] = $(&quot;#swimdistance&quot;).val();
&#x2F;&#x2F;console.log(spmap);							
					&#x2F;&#x2F; itterate over results and pick out the one required	
						spmap[&#x27;rows&#x27;].forEach(function(rowswimrs){
&#x2F;&#x2F;console.log(rowswimrs[&#x27;key&#x27;]);
							if(rowswimrs[&#x27;key&#x27;] == swimidin )
							{
								&#x2F;&#x2F; need to set time interval to retrieve
								var timerightnow = new Date();
								startswimdate = Date.parse(timerightnow); &#x2F;&#x2F; current time&#x2F;date
								
								&#x2F;&#x2F; change length goe back in time depending on chart or summary context (plus need to sync with online couchdb for all data history)
								if(datatypein == &quot;splitdatain&quot;)
								{
									endswimdateperiod = startswimdate - 10800000;  &#x2F;&#x2F;go back 3 hours
								}
								else if(datatypein == &quot;persummaryid&quot;)
								{
									endswimdateperiod = startswimdate - 315360000000;  &#x2F;&#x2F; go back 10 years from todays date
								}	
&#x2F;&#x2F;console.log(endswimdateperiod + &#x27;go back three hours&#x27; + startswimdate + &#x27;current time&#x27; + &#x27;saveactual time&#x27; + rowswimrs[&#x27;value&#x27;][&#x27;sessionid&#x27;]);								
								if( rowswimrs[&#x27;value&#x27;][&#x27;sessionid&#x27;] &lt; startswimdate &amp;&amp; rowswimrs[&#x27;value&#x27;][&#x27;sessionid&#x27;] &gt; endswimdateperiod)
								{
&#x2F;&#x2F;console.log(&#x27;time filter passed&#x27;);								
									&#x2F;&#x2F; need a set of filters for time period and swim setting e.g. stroke distance etc
									if(swimsetlive[&quot;swimstyle&quot;] ==  rowswimrs[&#x27;value&#x27;][&#x27;swiminfo&#x27;][&#x27;swimstyle&#x27;] &amp;&amp; swimsetlive[&quot;swimstroke&quot;] ==  rowswimrs[&#x27;value&#x27;][&#x27;swiminfo&#x27;][&#x27;swimstroke&#x27;]  &amp;&amp; swimsetlive[&quot;swimtechnique&quot;] ==  rowswimrs[&#x27;value&#x27;][&#x27;swiminfo&#x27;][&#x27;swimtechnique&#x27;] &amp;&amp; swimsetlive[&quot;swimdistance&quot;] ==  rowswimrs[&#x27;value&#x27;][&#x27;swiminfo&#x27;][&#x27;swimdistance&#x27;] )
									{
									&#x2F;&#x2F;pass the lane data to get html ready
										historicalswimdata[rowswimrs[&#x27;value&#x27;][&#x27;sessionid&#x27;]] = rowswimrs[&#x27;value&#x27;];
									
									}
								}
							}	
						});
&#x2F;&#x2F;console.log( historicalswimdata);		
&#x2F;*						
console.log(&#x27;test object&#x27;);
		alivepouch = {&quot;1&quot;:&quot;1&quot;};
		aswimidin = &#x27;3865253--554494698&#x27;;
		ahistoricalswimdata = {};
		ahistoricalswimdata[&#x27;sessionid&#x27;] = 1364553195000;
		ahistoricalswimdata[&#x27;splittimes&#x27;] = [1074, 2399];	
		ahistoricalswimdata[&#x27;swiminfo&#x27;] = {&quot;swimdate&quot;:&quot;2013-03-29T10:33:15.109Z&quot;, &quot;swimdistance&quot;:&quot;100&quot;, &quot;swimsplit&quot;:&quot;50&quot;, &quot;swimstroke&quot;:&quot;freestyle&quot;, &quot;swimstyle&quot;:&quot;training&quot;, &quot;swimtechnique&quot;:&quot;swim&quot;};

console.log(alivepouch);
console.log(aswimidin);
console.log(ahistoricalswimdata);
newobjecttes = {};
newobjecttes[&#x27;1364553195000&#x27;] = ahistoricalswimdata;
console.log(newobjecttes);
*&#x2F;		
							&#x2F;&#x2F; what is data for
							if(datatypein == &quot;splitdatain&quot;)
							{
							&#x2F;&#x2F;return historicalswimdata;
								visthedata = liveHTML.visualiseme(livepouch, swimidin, historicalswimdata);
								swimidin = &#x27;&#x27;;
								historicalswimdata = &#x27;&#x27;;

							}
							else if(datatypein == &quot;persummaryid&quot;)
							{
							&#x2F;&#x2F;return historicalswimdata;
								visthedata = liveHTML.summaryme(livepouch, swimidin, historicalswimdata);
								swimidin = &#x27;&#x27;;
								historicalswimdata = &#x27;&#x27;;

							}
							else
							{
								&#x2F;&#x2F; chart data
								visthedata = liveHTML.visualisechart(livepouch, swimidin, historicalswimdata);
								swimidin = &#x27;&#x27;;
								historicalswimdata = &#x27;&#x27;;
							}
					});
};
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
